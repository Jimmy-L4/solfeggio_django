/*json_delta.js v1.1.3
Copyright 2012-2015 Philip J. Roberts. BSD terms apply: see http://phil-roberts.name/json_delta/license.html*/
JSON_delta={patch:function(c,b){var a;for(a=0;a<b.length;a++){c=this.patchStanza(c,b[a])}return c},diff:function(g,d,a,c){c=c!==undefined?c:[];a=a!==undefined?a:true;var b=[[c,d]],f=[],e;if(this.structureWorthInvestigating(g,d)){e=this.commonality(g,d);if(a){f=this.needleDiff(g,d,a,c)}else{if(e<0.5){f=this.thisLevelDiff(g,d,c,e)}else{f=this.keysetDiff(g,d,a,c)}}}else{f=this.thisLevelDiff(g,d,c,0)}if(a){if(JSON.stringify(b).length<JSON.stringify(f).length){f=b}}if(c.length===0){if(f.length>1){f=this.sortStanzas(f)}}return f},isStrictlyEqual:function(d,c){var a,e,b;if(this.isTerminal(d)&&this.isTerminal(c)){return(d===c)}if(this.isTerminal(d)||this.isTerminal(c)){return false}if(d instanceof Array&&c instanceof Array){if(d.length!==c.length){return false}for(a=0;a<d.length;a++){if(!this.isStrictlyEqual(d[a],c[a])){return false}}return true}if(d instanceof Array||c instanceof Array){return false}e=this.computeKeysets(d,c);if(e[1].length!==0||e[2].length!==0){return false}for(a=0;a<e[0].length;a++){b=e[0][a];if(!this.isStrictlyEqual(d[b],c[b])){return false}}return true},isTerminal:function(a){if(typeof a==="string"||typeof a==="number"||typeof a==="boolean"||a===null){return true}return false},appendKey:function(f,b,d){d=d!==undefined?d:[];var a=b.length,e,c;for(c=0;c<f.length;c++){e=f[c][0];if(f[c].length>1&&e.length===d.length+1&&e[e.length-1]>=a){a=e[e.length-1]+1}}return a},loopOver:function(c,d){var b,a;if(c instanceof Array){for(b=0;b<c.length;b++){d(c,b)}}else{for(a in c){if(c.hasOwnProperty(a)){d(c,a)}}}},splitDeletions:function(b){var a;if(b.length===0){return[[],b]}b.sort(function(d,c){return c.length-d.length});for(a=0;a<b.length;a++){if(b[a].length===1){break}}return[b.slice(0,a),b.slice(a)]},sortStanzas:function(b){var a=this.splitDeletions(b);a[0].sort(function(d,c){return d[0].slice(-1)[0]-c[0].slice(-1)[0]});a[1].sort(function(d,c){return c[0].slice(-1)[0]-d[0].slice(-1)[0]});return a[0].concat(a[1])},computeKeysets:function(e,b){var a=[],d=[],f=[];var c=a;this.loopOver(e,function(h,g){if(b[g]!==undefined){c=a}else{c=d}c.push(g)});this.loopOver(b,function(h,g){if(e[g]===undefined){f.push(g)}});return[a,d,f]},structureWorthInvestigating:function(b,a){if(this.isTerminal(b)||this.isTerminal(a)){return false}if((b.length===0)||(a.length===0)){return false}if((b instanceof Array)&&(a instanceof Array)){return true}if((b instanceof Array)||(a instanceof Array)){return false}if((typeof b==="object")&&(typeof a==="object")){return true}return false},commonality:function(e,j){var d=0,h=0;var f,b,c,g,a,i;if(this.isTerminal(e)||this.isTerminal(j)){return 0}if((e instanceof Array)&&(j instanceof Array)){for(i=0;i<e.length;i++){f=e[i];if(j.indexOf(f)!==-1){d++}}h=Math.max(e.length,j.length)}else{if((e instanceof Array)||(j instanceof Array)){return 0}b=this.computeKeysets(e,j);c=b[0];g=b[1];a=b[2];d=c.length;h=c.length+g.length+a.length;for(i=0;i<a.length;i++){f=a[i];if(g.indexOf(f)===-1){h++}}}if(h===0){return 0}return d/h},thisLevelDiff:function(g,e,d,f){var c=[],a,b;d=d!==undefined?d:[];if(f===undefined){f=this.commonality(g,e)}if(f){var h=this.computeKeysets(g,e);for(a=0;a<h[0].length;a++){b=h[0][a];if(g[b]!==e[b]){c.push([d.concat([b]),e[b]])}}for(a=0;a<h[1].length;a++){b=h[1][a];c.push([d.concat([b])])}for(a=0;a<h[2].length;a++){b=h[2][a];c.push([d.concat([b]),e[b]])}return c}if(!this.isStrictlyEqual(g,e)){return[[d,e]]}return[]},keysetDiff:function(f,e,a,d){a=a!==undefined?a:true;var c=[],b;var g=this.computeKeysets(f,e);for(b=0;b<g[1].length;b++){c.push([d.concat(g[1][b])])}for(b=0;b<g[2].length;b++){c.push([d.concat(g[2][b]),e[g[2][b]]])}for(b=0;b<g[0].length;b++){c=c.concat(this.diff(f[g[0][b]],e[g[0][b]],a,d.concat([g[0][b]])))}return c},needleDiff:function(g,w,v,x){if(!(g instanceof Array&&w instanceof Array)){return this.keysetDiff(g,w,v,x)}v=v!==undefined?v:true;var d=0,l=[],u,s,a,k,m;var j,b,o,p;var e,f,t,q;var n=function(){if(m+1<l.length){return l[m+1].concat(JSON_delta.diff(o,p,v,x.concat([a])))}};var r=function(){if(j.length>0){return j[0].concat([[x.concat([a])]])}};var h=function(){if(m===d){return l[m].concat([[x.concat([JSON_delta.appendKey(l[m],g,x)]),p]])}};var c=[n,r,h];for(u=0;u<=g.length;u++){l.unshift([]);for(s=0;s<u;s++){l[0].push([x.concat([s])])}}for(k=0;k<w.length;k++){p=w[k];b=Math.min(k,g.length-1);j=[];for(a=b;a<g.length;a++){o=g[a];m=g.length-a-1;f=Infinity;for(u=0;u<c.length;u++){t=c[u]();if(t!==undefined){e=JSON.stringify(t).length;if(e<f){q=t;f=e}}}j.unshift(q)}l=j}return q},patchStanza:function(f,e){var c=e[0];switch(c.length){case 0:f=e[1];break;case 1:if(e.length===1){if(f.splice===undefined){delete f[c[0]]}else{f.splice(c[0],1)}}else{f[c[0]]=e[1]}break;default:var a=c.slice(1),b=f[c[0]];var d=[a].concat(e.slice(1));if(b===undefined){if(typeof a[0]==="string"){b={}}else{b=[]}}f[c[0]]=this.patchStanza(b,d)}return f}};